'''
D.Melgar 10-2013
Tools to batch compute the qc metrics for the GM data
'''

#Global variables and statements
home='/home/sopac/GM/'
gpsgain=1e6 #Because at SCEDC it is stored in micrometers (I know right?)
accgain=1




def qc(day,month,year,dopsd=True,doppsd=True,reset=True):
    '''
    Compute QC metrics for all files in one days worth of data
    All variables EXCEPT the PPSD are save in a individual .npz files that sgould be 
    stored under a daily folder. The PPSD gets updated  every day so there is only
    a single file.
    '''
    import datetime,qcgm,os
    from glob import glob
    from obspy.core import read
    from shutil import rmtree
    from numpy import savez
    
    doy=datetime.date(year,month,day).strftime('%j')
    #Data directory
    datadir=home+'data/'+str(year)+doy+'/'
    procdir=home+'proc/'+str(year)+doy+'/'
    #Try to make the daily proc directory
    try:
        print 'procdir not found, creating it...'
        os.mkdir(procdir)
        imdone=False #Doesn't exist, continue procing
    except: #Folder exists already, delete or keep?
        if reset==True: #Hard reset, delete and remake directory
            print 'procdir exists but you requested a hard reset, deleting...'
            rmtree(procdir)
            os.mkdir(procdir)
            imdone=False
        else:
            print procdir+' exists and you requested a soft reset, exiting...'
            imdone=True
    if not imdone: #Get going
        #get list of files to be processed
        files=glob(datadir+'*.sac')
        
        for k in range(len(files)):
            print 'Working on file '+files[k]
            st=read(files[k])
            
            #Which type of instruemnt is it? apply gain and define some numbers
            if st[0].stats.channel[1]=='N':#Accel
                print ' -- Channel is strong motion'
                st=qcgm.applygain(st,accgain)
                NFFT=2**18
                noverlap=NFFT/2
                Fs=st[0].stats.delta
            elif st[0].stats.channel[1]=='Y':#GPS
                print ' -- Channel is GPS'
                st=qcgm.applygain(st,gpsgain)
                NFFT=256
                noverlap=NFFT/2
                Fs=st[0].stats.delta
                
            #Now do all the metrics
            #compute usual psd
            if dopsd:
                print '        Computing PSD'
                T,P=qcgm.psd(st[0],NF=NFFT,nover=noverlap,Fsample=Fs)
                #save to npz file
                fid=open(procdir+st[0].stats.station+'.'+st[0].stats.channel+
                                                            '.psd.npz','wb')
                savez(fid,T=T,P=P)
                fid.close()
            #Compute PPSD
            if doppsd:
                print '        computing PPSD'
                qcgm.getppsd(st[0])
    
            
                    
                                    
def qcplots(day,month,year,specplot=True,reset=False):
    '''
    Make the QC plots and save to daily directory
    '''
    
    import os,datetime,cPickle
    from shutil import rmtree
    
    doy=datetime.date(year,month,day).strftime('%j')
    #Define directories
    plotdir=home+'plots/'+str(year)+doy
    procdir=home+'proc/'
    ppsddir=home+'proc/ppsd/'
    #Try to make directory
    try:
        os.mkdir(dir)
        imdone=False #Doesn't exist, make the plots
    except: #Folder exists already, delete or keep?
        if reset==True: #Hard reset, delete and remake directory
            rmtree(dir)
            os.mkdir(dir)
            imdone=False
        else:
            print 'Folder '+plotdir+' exists and you requested a soft reset, exiting...'
            imdone=True
    if not imdone: #Make the plots
        if specplot:
            pass
            #Get PSD
            
            
def batchqc():
    import numpsy as np
    day=np.arange(1,25,1)
    month=10*np.ones(day.shape)
    year=2013*np.ones(day.shape)
    #Make integers
    day=day.astype(int)
    month=month.astype(int)
    year=year.astype(int)
    for k in range(len(day)):


        
    
